{% extends 'base.html' %}

{% block title %}Camera - Attendance AI{% endblock %}

{% block extra_css %}
<style>
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .left-column {
        display: flex;
        flex-direction: column;
    }
    
    .right-column {
        display: flex;
        flex-direction: column;
    }
    
    #video-container {
        position: relative;
        width: 100%;
        height: 480px;
        margin-bottom: 20px;
    }
    
    #camera-placeholder {
        width: 100%;
        height: 100%;
        background-color: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
    }
    
    #camera-stream {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    .hidden {
        display: none !important;
    }
    
    #face-gallery {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        background-color: #f9f9f9;
        min-height: 480px;
        max-height: 600px;
        overflow-y: auto;
    }
    
    #face-gallery h3 {
        margin-top: 0;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .face-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .face-card:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    
    .face-thumbnail {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border: 1px solid #ddd;
        margin-bottom: 10px;
    }
    
    .face-name {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .face-status {
        font-size: 0.85em;
        padding: 3px 8px;
        border-radius: 10px;
        margin-top: 5px;
    }
    
    .status-in-view {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-out-of-view {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .face-actions {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    
    #recognition-controls {
        margin: 20px 0;
    }
    
    #camera-selector {
        margin-bottom: 20px;
    }
    
    #camera-info {
        margin-bottom: 15px;
    }
    
    .meeting-banner {
        background-color: #4CAF50;
        color: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .no-meeting-banner {
        background-color: #f44336;
        color: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .banner-link {
        color: white;
        text-decoration: underline;
    }
    
    .alert {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .btn {
        padding: 8px 12px;
        margin: 0 5px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
    }
    
    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }
    
    .btn-secondary {
        background-color: #f1f1f1;
        color: #333;
        border: 1px solid #ddd;
    }
    
    .btn-info {
        background-color: #17a2b8;
        color: white;
    }
    
    .btn-warning {
        background-color: #ffc107;
        color: #333;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    #enroll-form {
        margin: 20px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    
    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    
    .form-buttons {
        margin-top: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Camera Stream</h2>
    </div>
    <div class="card-body">
        {% if active_meeting %}
        <div class="meeting-banner">
            <p><strong>Active Meeting:</strong> {{ active_meeting['title'] }}</p>
            <p>Started: {{ active_meeting['start_time'].strftime('%Y-%m-%d %H:%M') }}</p>
            <p><a href="{{ url_for('meetings.view', id=active_meeting['id']) }}" class="banner-link">View Meeting Details</a></p>
        </div>
        {% else %}
        <div class="no-meeting-banner">
            <p>No active meeting. Attendance will not be recorded.</p>
            <p><a href="{{ url_for('meetings.create') }}" class="banner-link">Start a Meeting</a></p>
        </div>
        {% endif %}
        
        <div id="camera-selector">
            <button id="refresh-cameras" class="btn btn-secondary">Refresh Camera List</button>
            <select id="camera-select" style="padding: 6px; margin: 0 5px;">
                <option value="0">Default Camera</option>
            </select>
            <button id="camera-toggle" class="btn btn-primary">Start Camera</button>
        </div>
        
        <div id="camera-info"></div>
        
        <div id="recognition-controls" class="hidden">
            <button id="toggle-recognition" class="btn btn-primary">Enable Face Recognition</button>
            <button id="toggle-show-faces" class="btn btn-info hidden">Show Face Boxes</button>
        </div>
        
        <div class="grid-container">
            <div class="left-column">
                <div id="video-container">
                    <div id="camera-placeholder" class="placeholder-image">
                        <p>Camera is not active. Click "Start Camera" to begin.</p>
                    </div>
                    <img id="camera-stream" src="" alt="Camera Stream" class="hidden">
                </div>
            </div>
            
            <div class="right-column">
                <div id="face-gallery" class="hidden">
                    <h3>Detected Faces</h3>
                    <div id="face-list">
                        <p id="no-faces-message">No faces detected yet. Enable face recognition to detect faces.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="enroll-form" class="hidden">
            <h3>Enroll New Member</h3>
            
            <div id="selected-face-preview" style="text-align: center; margin-bottom: 20px;">
                <img id="face-to-enroll" src="" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd;">
            </div>
            
            {% if active_meeting %}
            <div class="alert alert-success">
                Member will be automatically marked as present for the active meeting: <strong>{{ active_meeting['title'] }}</strong>
            </div>
            {% else %}
            <div class="alert alert-warning">
                No active meeting. Attendance will not be recorded.
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="person-name">Full Name</label>
                <input type="text" id="person-name" placeholder="Full Name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="person-major">Major</label>
                <input type="text" id="person-major" placeholder="Major" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="person-age">Age</label>
                <input type="number" id="person-age" placeholder="Age" class="form-control" min="1" max="120">
            </div>
            
            <div class="form-group">
                <label for="person-bio">Bio</label>
                <textarea id="person-bio" placeholder="Brief bio" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-buttons">
                <button id="save-face" class="btn btn-primary">Save Member</button>
                <button id="cancel-enroll" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Camera elements
        const cameraSelect = document.getElementById('camera-select');
        const cameraToggle = document.getElementById('camera-toggle');
        const refreshBtn = document.getElementById('refresh-cameras');
        const cameraStream = document.getElementById('camera-stream');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const cameraInfo = document.getElementById('camera-info');
        const recognitionControls = document.getElementById('recognition-controls');
        
        // Face gallery elements
        const faceGallery = document.getElementById('face-gallery');
        const faceList = document.getElementById('face-list');
        const noFacesMessage = document.getElementById('no-faces-message');
        
        // Recognition elements
        const toggleRecognitionBtn = document.getElementById('toggle-recognition');
        const toggleShowFacesBtn = document.getElementById('toggle-show-faces');
        
        // Enrollment elements
        const enrollForm = document.getElementById('enroll-form');
        const faceToEnroll = document.getElementById('face-to-enroll');
        const personNameInput = document.getElementById('person-name');
        const personMajorInput = document.getElementById('person-major');
        const personAgeInput = document.getElementById('person-age');
        const personBioInput = document.getElementById('person-bio');
        const saveFaceBtn = document.getElementById('save-face');
        const cancelEnrollBtn = document.getElementById('cancel-enroll');
        
        // State variables
        let recognitionEnabled = false;
        let showFaces = false;
        let currentCameraId = 0;
        let resultUpdateInterval = null;
        let cameraActive = false;
        let currentSelectedFaceIndex = -1;
        
        // Function to load camera list
        function loadCameraList() {
            fetch('/camera/list')
                .then(response => response.json())
                .then(data => {
                    // Clear current options
                    cameraSelect.innerHTML = '';
                    
                    // Add detected cameras
                    data.cameras.forEach(cameraId => {
                        const option = document.createElement('option');
                        option.value = cameraId;
                        option.textContent = `Camera ${cameraId}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    if (data.cameras.length === 0) {
                        const option = document.createElement('option');
                        option.value = "0";
                        option.textContent = "Default Camera";
                        cameraSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading camera list:', error);
                    showToast('Error loading camera list: ' + error.message, 'danger');
                });
        }
        
        // Function to display a toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type}`;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '1000';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Function to check if camera is active
        function checkCameraStatus() {
            fetch('/camera/status')
                .then(response => response.json())
                .then(data => {
                    updateCameraUI(data.active);
                })
                .catch(error => {
                    console.error('Error checking camera status:', error);
                    showToast('Error checking camera status: ' + error.message, 'danger');
                });
        }
        
        // Function to update camera UI based on status
        function updateCameraUI(active) {
            cameraActive = active;
            cameraToggle.textContent = active ? 'Stop Camera' : 'Start Camera';
            
            if (active) {
                // Show camera stream and controls
                cameraPlaceholder.classList.add('hidden');
                cameraStream.classList.remove('hidden');
                recognitionControls.classList.remove('hidden');
                
                // Load camera info
                loadCameraInfo();
            } else {
                // Hide camera stream and controls
                cameraPlaceholder.classList.remove('hidden');
                cameraStream.classList.add('hidden');
                recognitionControls.classList.add('hidden');
                faceGallery.classList.add('hidden');
                enrollForm.classList.add('hidden');
                
                // Clear intervals
                if (resultUpdateInterval) {
                    clearInterval(resultUpdateInterval);
                    resultUpdateInterval = null;
                }
                
                // Reset recognition state
                recognitionEnabled = false;
            }
        }
        
        // Function to start camera
        function startCamera() {
            const cameraId = parseInt(cameraSelect.value);
            
            fetch('/camera/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: cameraId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentCameraId = cameraId;
                    // Use a timestamp to prevent caching issues
                    const timestamp = new Date().getTime();
                    cameraStream.src = `/camera/stream?id=${cameraId}&show_faces=false&t=${timestamp}`;
                    updateCameraUI(true);
                } else {
                    showToast('Error starting camera: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error starting camera:', error);
                showToast('Error starting camera: ' + error.message, 'danger');
            });
        }
        
        // Function to stop camera
        function stopCamera() {
            fetch('/camera/stop', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                updateCameraUI(false);
            })
            .catch(error => {
                console.error('Error stopping camera:', error);
                showToast('Error stopping camera: ' + error.message, 'danger');
            });
        }
        
        // Function to load camera info
        function loadCameraInfo() {
            fetch('/camera/info')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        cameraInfo.textContent = data.error;
                        return;
                    }
                    
                    cameraInfo.innerHTML = `
                        <p>Camera ID: ${data.id} | Resolution: ${data.width}x${data.height} | FPS: ${data.fps.toFixed(1)}</p>
                    `;
                    
                    // Update recognition state based on camera info
                    recognitionEnabled = data.recognition_enabled;
                    updateRecognitionUI();
                })
                .catch(error => {
                    console.error('Error loading camera info:', error);
                });
        }
        
        // Function to update face gallery
        function updateFaceGallery(faces) {
            // Clear the current face list
            faceList.innerHTML = '';
            
            if (faces.length === 0) {
                noFacesMessage.classList.remove('hidden');
                return;
            }
            
            noFacesMessage.classList.add('hidden');
            
            // First, sort faces: known faces first, then sort by in_view (true first)
            faces.sort((a, b) => {
                // Sort known faces before unknown faces
                if (a.type === 'known' && b.type === 'unknown') return -1;
                if (a.type === 'unknown' && b.type === 'known') return 1;
                
                // Then sort by in_view status (in-view faces first)
                if (a.in_view && !b.in_view) return -1;
                if (!a.in_view && b.in_view) return 1;
                
                // Finally sort by last_seen (most recently seen first)
                return a.time_since_seen - b.time_since_seen;
            });
            
            // Add each face to the gallery
            faces.forEach((face, index) => {
                const faceCard = document.createElement('div');
                faceCard.className = 'face-card';
                faceCard.dataset.faceIndex = index;
                faceCard.dataset.thumbnailId = face.thumbnail_id;
                
                // Only allow enrollment actions for unknown faces that are in view
                if (face.type === 'unknown' && face.in_view) {
                    faceCard.addEventListener('click', () => selectFaceToEnroll(face.thumbnail_id, face));
                }
                
                // Create face thumbnail
                const thumbnail = document.createElement('img');
                thumbnail.className = 'face-thumbnail';
                thumbnail.alt = face.name;
                thumbnail.src = `/camera/face_thumbnail/${face.thumbnail_id}`;
                
                // Add face name
                const nameElem = document.createElement('div');
                nameElem.className = 'face-name';
                nameElem.textContent = face.name;
                
                // Add status indicator
                const statusElem = document.createElement('div');
                statusElem.className = `face-status ${face.in_view ? 'status-in-view' : 'status-out-of-view'}`;
                statusElem.textContent = face.in_view ? 'In View' : 'Not in View';
                
                // Add action buttons container
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'face-actions';
                
                // Add appropriate actions based on face type
                if (face.type === 'unknown') {
                    if (face.in_view) {
                        // For unknown faces in view: add enroll button
                        const enrollBtn = document.createElement('button');
                        enrollBtn.className = 'btn btn-warning';
                        enrollBtn.textContent = 'Enroll';
                        enrollBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent the card click event
                            selectFaceToEnroll(face.thumbnail_id, face);
                        });
                        actionsContainer.appendChild(enrollBtn);
                    }
                    
                    // For all unknown faces: add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-danger';
                    removeBtn.textContent = 'Dismiss';
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the card click event
                        
                        // Call the API to remove this face
                        fetch(`/camera/remove_unknown_face/${face.thumbnail_id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove the face card from the UI
                                faceCard.remove();
                                showToast('Face removed', 'success');
                            } else {
                                showToast(data.message || 'Failed to remove face', 'warning');
                            }
                        })
                        .catch(error => {
                            console.error('Error removing face:', error);
                            showToast('Error removing face: ' + error.message, 'danger');
                        });
                    });
                    actionsContainer.appendChild(removeBtn);
                }
                
                // Assemble the card
                faceCard.appendChild(thumbnail);
                faceCard.appendChild(nameElem);
                faceCard.appendChild(statusElem);
                
                // Only add actions container if it has buttons
                if (actionsContainer.children.length > 0) {
                    faceCard.appendChild(actionsContainer);
                }
                
                // Add to the list
                faceList.appendChild(faceCard);
            });
        }
        
        // Function to select a face for enrollment
        function selectFaceToEnroll(thumbnailId, face) {
            currentSelectedFaceIndex = thumbnailId;
            
            // Set the face image in the enrollment form
            faceToEnroll.src = `/camera/face_thumbnail/${thumbnailId}`;
            
            // Show the enrollment form
            enrollForm.classList.remove('hidden');
            
            // Scroll to the form
            enrollForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Function to update recognition results and face gallery
        function updateRecognitionResult() {
            if (!recognitionEnabled) return;
            
            fetch('/camera/recognition/result')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        return;
                    }
                    
                    // Update the face gallery with the detected faces
                    updateFaceGallery(data.faces);
                })
                .catch(error => {
                    console.error('Error updating recognition result:', error);
                    showToast('Error updating recognition result: ' + error.message, 'danger');
                });
        }
        
        // Function to update UI based on recognition state
        function updateRecognitionUI() {
            toggleRecognitionBtn.textContent = recognitionEnabled ? 
                'Disable Face Recognition' : 'Enable Face Recognition';
            
            if (recognitionEnabled) {
                faceGallery.classList.remove('hidden');
                toggleShowFacesBtn.classList.remove('hidden');
                // Start periodic result updates
                if (!resultUpdateInterval) {
                    resultUpdateInterval = setInterval(updateRecognitionResult, 1000);
                    updateRecognitionResult();
                }
            } else {
                faceGallery.classList.add('hidden');
                toggleShowFacesBtn.classList.add('hidden');
                enrollForm.classList.add('hidden');
                // Stop periodic updates
                if (resultUpdateInterval) {
                    clearInterval(resultUpdateInterval);
                    resultUpdateInterval = null;
                }
            }
        }
        
        // Toggle camera
        cameraToggle.addEventListener('click', function() {
            if (cameraActive) {
                stopCamera();
            } else {
                startCamera();
            }
        });
        
        // Toggle face recognition
        toggleRecognitionBtn.addEventListener('click', function() {
            fetch('/camera/recognition/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: !recognitionEnabled }),
            })
            .then(response => response.json())
            .then(data => {
                recognitionEnabled = data.recognition_enabled;
                updateRecognitionUI();
            })
            .catch(error => {
                console.error('Error toggling recognition:', error);
                showToast('Error toggling recognition: ' + error.message, 'danger');
            });
        });
        
        // Toggle showing face boxes
        toggleShowFacesBtn.addEventListener('click', function() {
            showFaces = !showFaces;
            toggleShowFacesBtn.textContent = showFaces ? 
                'Hide Face Boxes' : 'Show Face Boxes';
            
            // Update the stream URL with a timestamp to force reload
            const timestamp = new Date().getTime();
            cameraStream.src = `/camera/stream?id=${currentCameraId}&show_faces=${showFaces}&t=${timestamp}`;
        });
        
        // Refresh camera list
        refreshBtn.addEventListener('click', loadCameraList);
        
        // Handle member enrollment
        saveFaceBtn.addEventListener('click', function() {
            const name = personNameInput.value.trim();
            const major = personMajorInput.value.trim();
            const age = personAgeInput.value ? parseInt(personAgeInput.value) : null;
            const bio = personBioInput.value.trim();
            
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }
            
            // Show processing indicator
            saveFaceBtn.textContent = "Saving...";
            saveFaceBtn.disabled = true;
            
            fetch('/camera/recognition/enroll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    name: name,
                    major: major || null,
                    age: age,
                    bio: bio || null,
                    face_index: currentSelectedFaceIndex
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                } else {
                    showToast(data.message || "Member enrolled successfully", 'success');
                    
                    // Hide form and reset fields
                    enrollForm.classList.add('hidden');
                    personNameInput.value = '';
                    personMajorInput.value = '';
                    personAgeInput.value = '';
                    personBioInput.value = '';
                    
                    // Reset button
                    saveFaceBtn.textContent = "Save Member";
                    saveFaceBtn.disabled = false;
                    
                    // Force immediate update of the recognition results
                    updateRecognitionResult();
                    
                    // Add timestamp to force refresh of the video stream
                    const timestamp = new Date().getTime();
                    cameraStream.src = `/camera/stream?id=${currentCameraId}&show_faces=${showFaces}&t=${timestamp}`;
                }
            })
            .catch(error => {
                console.error('Error enrolling face:', error);
                showToast('Error enrolling face: ' + error.message, 'danger');
                
                // Reset button
                saveFaceBtn.textContent = "Save Member";
                saveFaceBtn.disabled = false;
            });
        });
        
        cancelEnrollBtn.addEventListener('click', function() {
            enrollForm.classList.add('hidden');
            personNameInput.value = '';
            personMajorInput.value = '';
            personAgeInput.value = '';
            personBioInput.value = '';
            
            // Reset button if it was in saving state
            saveFaceBtn.textContent = "Save Member";
            saveFaceBtn.disabled = false;
            
            // Reset selected face index
            currentSelectedFaceIndex = -1;
        });
        
        // Load cameras on page load
        loadCameraList();
        checkCameraStatus();
    });
</script>
{% endblock %}