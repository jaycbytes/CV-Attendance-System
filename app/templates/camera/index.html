{% extends 'base.html' %}

{% block title %}Camera - Attendance AI{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        margin-bottom: 30px;
    }
    
    .left-column {
        flex: 0.65;
        display: flex;
        flex-direction: column;
    }
    
    .right-column {
        flex: 0.35;
        display: flex;
        flex-direction: column;
    }
    
    #video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        margin-bottom: 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }
    
    #camera-placeholder {
        width: 100%;
        height: 100%;
        background-color: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
    }
    
    #camera-stream {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    .hidden {
        display: none !important;
    }
    
    /* Welcome Member Card */
    #welcome-card {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
        height: 100%;
        position: relative;
        overflow: hidden;
        transition: background 0.5s ease;
    }
    
    #welcome-card.no-member {
        background: linear-gradient(135deg, #9e9e9e, #616161);
        justify-content: center;
        text-align: center;
    }
    
    /* Queue indicator dots */
    .queue-indicators {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 10px;
    }
    
    .queue-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.4);
        transition: background-color 0.3s ease, transform 0.3s ease;
    }
    
    .queue-dot.active {
        background-color: white;
        transform: scale(1.2);
    }
    
    .member-photo {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        margin: 0 auto 20px;
        display: block;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .welcome-header {
        font-size: 1.8rem;
        margin-bottom: 20px;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .member-info {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 15px;
        width: 100%;
        margin: 10px auto 0;
        text-align: left;
        box-sizing: border-box;
    }
    
    .member-info-item {
        margin-bottom: 12px;
        padding: 0 5px;
    }
    
    .member-info-label {
        font-weight: bold;
        font-size: 0.9rem;
        text-transform: uppercase;
        margin-bottom: 3px;
        opacity: 0.9;
    }
    
    .member-info-value {
        font-size: 1.1rem;
        word-wrap: break-word;
    }
    
    /* Member Modal Form */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .member-modal {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 0;
        position: relative;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        color: white;
        padding: 15px 20px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        line-height: 1;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .modal-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-preview {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }
    
    .modal-face-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #4CAF50;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    
    .member-form-group {
        margin-bottom: 15px;
    }
    
    .member-form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #444;
    }
    
    .member-form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .member-form-input:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    
    /* Face Galleries */
    .face-galleries {
        margin-top: 30px;
    }
    
    .face-gallery {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .face-gallery h3 {
        margin-top: 0;
        margin-bottom: 15px;
        text-align: center;
        font-size: 1.3rem;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    
    /* Face Cards */
    .faces-container {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 15px;
        padding: 15px 5px;
        scrollbar-width: thin;
    }
    
    .faces-container::-webkit-scrollbar {
        height: 6px;
    }
    
    .faces-container::-webkit-scrollbar-thumb {
        background-color: #ddd;
        border-radius: 6px;
    }
    
    .faces-container::-webkit-scrollbar-track {
        background-color: #f5f5f5;
    }
    
    .face-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        min-width: 160px;
        max-width: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        flex-shrink: 0;
    }
    
    .face-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        cursor: pointer;
    }
    
    .face-thumbnail {
        width: 130px;
        height: 130px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #eee;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .face-name {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 1rem;
        text-align: center;
    }
    
    .face-status {
        font-size: 0.8rem;
        padding: 3px 8px;
        border-radius: 12px;
        margin-top: 5px;
        font-weight: 500;
    }
    
    .status-in-view {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-out-of-view {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .face-actions {
        display: flex;
        gap: 5px;
        margin-top: 12px;
        width: 100%;
        justify-content: center;
    }
    
    #recognition-controls {
        margin: 20px 0;
    }
    
    #camera-selector {
        margin-bottom: 20px;
    }
    
    #camera-info {
        margin-bottom: 15px;
    }
    
    .meeting-banner {
        background-color: #4CAF50;
        color: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .no-meeting-banner {
        background-color: #f44336;
        color: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .banner-link {
        color: white;
        text-decoration: underline;
    }
    
    .alert {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .btn {
        padding: 8px 12px;
        margin: 0 5px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
    }
    
    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }
    
    .btn-secondary {
        background-color: #f1f1f1;
        color: #333;
        border: 1px solid #ddd;
    }
    
    .btn-info {
        background-color: #17a2b8;
        color: white;
    }
    
    .btn-warning {
        background-color: #ffc107;
        color: #333;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    
    #enroll-form {
        margin: 20px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    
    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    
    .form-buttons {
        margin-top: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Camera Stream</h2>
    </div>
    <div class="card-body">
        {% if active_meeting %}
        <div class="meeting-banner">
            <p><strong>Active Meeting:</strong> {{ active_meeting['title'] }}</p>
            <p>Started: {{ active_meeting['start_time'].strftime('%Y-%m-%d %H:%M') }}</p>
            <p><a href="{{ url_for('meetings.view', id=active_meeting['id']) }}" class="banner-link">View Meeting Details</a></p>
        </div>
        {% else %}
        <div class="no-meeting-banner">
            <p>No active meeting. Attendance will not be recorded.</p>
            <p><a href="{{ url_for('meetings.create') }}" class="banner-link">Start a Meeting</a></p>
        </div>
        {% endif %}
        
        <div id="camera-selector">
            <button id="refresh-cameras" class="btn btn-secondary">Refresh Camera List</button>
            <select id="camera-select" style="padding: 6px; margin: 0 5px;">
                <option value="0">Default Camera</option>
            </select>
            <button id="camera-toggle" class="btn btn-primary">Start Camera</button>
        </div>
        
        <div id="camera-info"></div>
        
        <div id="recognition-controls" class="hidden">
            <button id="toggle-recognition" class="btn btn-primary">Enable Face Recognition</button>
            <button id="toggle-show-faces" class="btn btn-info hidden">Show Face Boxes</button>
        </div>
        
        <!-- Main Container: Video Stream + Welcome Card -->
        <div class="main-container">
            <!-- Left Column - Video Stream -->
            <div class="left-column">
                <div id="video-container">
                    <div id="camera-placeholder" class="placeholder-image">
                        <p>Camera is not active. Click "Start Camera" to begin.</p>
                    </div>
                    <img id="camera-stream" src="" alt="Camera Stream" class="hidden">
                </div>
            </div>
            
            <!-- Right Column - Welcome Card -->
            <div class="right-column">
                <div id="welcome-card" class="no-member">
                    <div id="no-member-message">
                        <h2>No Members Detected</h2>
                        <p>When someone is recognized, their information will appear here.</p>
                    </div>
                    
                    <div id="member-info-container" class="hidden">
                        <img id="member-photo" class="member-photo" src="" alt="Member Photo">
                        <h2 id="welcome-header" class="welcome-header">Welcome, <span id="member-name">Member</span>!</h2>
                        
                        <div class="member-info">
                            <div class="member-info-item">
                                <div class="member-info-label">Major</div>
                                <div id="member-major" class="member-info-value">Computer Science</div>
                            </div>
                            
                            <div class="member-info-item">
                                <div class="member-info-label">Age</div>
                                <div id="member-age" class="member-info-value">21</div>
                            </div>
                            
                            <div class="member-info-item">
                                <div class="member-info-label">Bio</div>
                                <div id="member-bio" class="member-info-value">Member biography will appear here.</div>
                            </div>
                            
                            <div class="member-info-item">
                                <div class="member-info-label">Meetings Attended</div>
                                <div id="member-meetings" class="member-info-value">5</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Queue indicators (dots) -->
                    <div id="queue-indicators" class="queue-indicators hidden">
                        <!-- Will be populated dynamically based on queue -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Face Galleries - Full Width -->
        <div class="face-galleries hidden" id="face-galleries">
            <!-- Recognized Members Gallery -->
            <div class="face-gallery" id="recognized-gallery">
                <h3>Recognized Members</h3>
                <div class="faces-container" id="recognized-faces">
                    <p id="no-recognized-message">No recognized members yet.</p>
                </div>
            </div>
            
            <!-- Unrecognized Faces Gallery -->
            <div class="face-gallery" id="unknown-gallery">
                <h3>Unrecognized Faces</h3>
                <div class="faces-container" id="unknown-faces">
                    <p id="no-unknown-message">No unrecognized faces detected.</p>
                </div>
            </div>
        </div>
        
        <!-- Member Edit/Add Modal -->
        <div id="member-modal-overlay" class="modal-overlay hidden">
            <div class="member-modal">
                <div class="modal-header">
                    <h2 id="member-modal-title" class="modal-title">Add New Member</h2>
                    <button id="close-modal-btn" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-preview">
                        <img id="modal-face-preview" class="modal-face-preview" src="" alt="Face Preview">
                    </div>
                    
                    <form id="member-form">
                        <input type="hidden" id="form-face-id" value="">
                        <input type="hidden" id="form-member-id" value="">
                        <input type="hidden" id="form-action" value="add"> <!-- 'add' or 'edit' -->
                        
                        <div class="member-form-group">
                            <label for="form-name" class="member-form-label">Full Name*</label>
                            <input type="text" id="form-name" class="member-form-input" required placeholder="Enter full name">
                        </div>
                        
                        <div class="member-form-group">
                            <label for="form-major" class="member-form-label">Major</label>
                            <input type="text" id="form-major" class="member-form-input" placeholder="Enter major">
                        </div>
                        
                        <div class="member-form-group">
                            <label for="form-age" class="member-form-label">Age</label>
                            <input type="number" id="form-age" class="member-form-input" placeholder="Enter age" min="1" max="120">
                        </div>
                        
                        <div class="member-form-group">
                            <label for="form-bio" class="member-form-label">Bio</label>
                            <textarea id="form-bio" class="member-form-input" rows="3" placeholder="Enter a brief bio"></textarea>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" id="cancel-form-btn" class="btn btn-secondary">Cancel</button>
                            <button type="submit" id="save-form-btn" class="btn btn-primary">Save Member</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="enroll-form" class="hidden">
            <h3>Enroll New Member</h3>
            
            <div id="selected-face-preview" style="text-align: center; margin-bottom: 20px;">
                <img id="face-to-enroll" src="" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd;">
            </div>
            
            {% if active_meeting %}
            <div class="alert alert-success">
                Member will be automatically marked as present for the active meeting: <strong>{{ active_meeting['title'] }}</strong>
            </div>
            {% else %}
            <div class="alert alert-warning">
                No active meeting. Attendance will not be recorded.
            </div>
            {% endif %}
            
            <div class="form-group">
                <label for="person-name">Full Name</label>
                <input type="text" id="person-name" placeholder="Full Name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="person-major">Major</label>
                <input type="text" id="person-major" placeholder="Major" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="person-age">Age</label>
                <input type="number" id="person-age" placeholder="Age" class="form-control" min="1" max="120">
            </div>
            
            <div class="form-group">
                <label for="person-bio">Bio</label>
                <textarea id="person-bio" placeholder="Brief bio" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-buttons">
                <button id="save-face" class="btn btn-primary">Save Member</button>
                <button id="cancel-enroll" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Camera elements
        const cameraSelect = document.getElementById('camera-select');
        const cameraToggle = document.getElementById('camera-toggle');
        const refreshBtn = document.getElementById('refresh-cameras');
        const cameraStream = document.getElementById('camera-stream');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const cameraInfo = document.getElementById('camera-info');
        const recognitionControls = document.getElementById('recognition-controls');
        
        // Face galleries elements
        const faceGalleries = document.getElementById('face-galleries');
        const recognizedGallery = document.getElementById('recognized-gallery');
        const unknownGallery = document.getElementById('unknown-gallery');
        const recognizedFaces = document.getElementById('recognized-faces');
        const unknownFaces = document.getElementById('unknown-faces');
        const noRecognizedMessage = document.getElementById('no-recognized-message');
        const noUnknownMessage = document.getElementById('no-unknown-message');
        
        // Welcome card elements
        const welcomeCard = document.getElementById('welcome-card');
        const noMemberMessage = document.getElementById('no-member-message');
        const memberInfoContainer = document.getElementById('member-info-container');
        const memberPhoto = document.getElementById('member-photo');
        const memberName = document.getElementById('member-name');
        const memberMajor = document.getElementById('member-major');
        const memberAge = document.getElementById('member-age');
        const memberBio = document.getElementById('member-bio');
        const memberMeetings = document.getElementById('member-meetings');
        const queueIndicators = document.getElementById('queue-indicators');
        
        // Member modal elements
        const memberModalOverlay = document.getElementById('member-modal-overlay');
        const memberModalTitle = document.getElementById('member-modal-title');
        const modalFacePreview = document.getElementById('modal-face-preview');
        const memberForm = document.getElementById('member-form');
        const formFaceId = document.getElementById('form-face-id');
        const formMemberId = document.getElementById('form-member-id');
        const formAction = document.getElementById('form-action');
        const formName = document.getElementById('form-name');
        const formMajor = document.getElementById('form-major');
        const formAge = document.getElementById('form-age');
        const formBio = document.getElementById('form-bio');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const saveFormBtn = document.getElementById('save-form-btn');
        
        // Member queue management
        let memberQueue = [];
        let currentMemberIndex = 0;
        let memberRotationInterval = null;
        const MEMBER_DISPLAY_TIME = 4000; // 4 seconds per member
        
        // Recognition elements
        const toggleRecognitionBtn = document.getElementById('toggle-recognition');
        const toggleShowFacesBtn = document.getElementById('toggle-show-faces');
        
        // Enrollment elements
        const enrollForm = document.getElementById('enroll-form');
        const faceToEnroll = document.getElementById('face-to-enroll');
        const personNameInput = document.getElementById('person-name');
        const personMajorInput = document.getElementById('person-major');
        const personAgeInput = document.getElementById('person-age');
        const personBioInput = document.getElementById('person-bio');
        const saveFaceBtn = document.getElementById('save-face');
        const cancelEnrollBtn = document.getElementById('cancel-enroll');
        
        // State variables
        let recognitionEnabled = false;
        let showFaces = false;
        let currentCameraId = 0;
        let resultUpdateInterval = null;
        let attendanceRecordInterval = null;  // For periodic attendance recording
        let cameraActive = false;
        let currentSelectedFaceIndex = -1;
        
        // Function to load camera list
        function loadCameraList(showToastOnSuccess = false) {
            // Show loading state on the refresh button if it exists
            if (refreshBtn) {
                const originalText = refreshBtn.textContent;
                refreshBtn.textContent = "Scanning...";
                refreshBtn.disabled = true;
            }
            
            showToast('Scanning for available cameras...', 'info');
            
            fetch('/camera/list')
                .then(response => response.json())
                .then(data => {
                    // Clear current options
                    cameraSelect.innerHTML = '';
                    
                    // Log the detected cameras for debugging
                    console.log(`Detected cameras: ${JSON.stringify(data.cameras)}`);
                    
                    // Remember the current selection if any
                    const previousSelection = cameraSelect.value;
                    let hasNonZeroOptions = false;
                    
                    // Add detected cameras
                    data.cameras.forEach(cameraId => {
                        const option = document.createElement('option');
                        option.value = cameraId;
                        option.textContent = `Camera ${cameraId}`;
                        cameraSelect.appendChild(option);
                        
                        // Remember if we have non-zero camera options (for USB cameras)
                        if (cameraId > 0) {
                            hasNonZeroOptions = true;
                        }
                    });
                    
                    // If we have a USB camera (index > 0) and we weren't already using a camera,
                    // automatically select the first non-zero camera (likely the USB webcam)
                    if (hasNonZeroOptions && (!previousSelection || previousSelection === "0")) {
                        // Find first non-zero camera
                        for (let i=0; i < cameraSelect.options.length; i++) {
                            if (parseInt(cameraSelect.options[i].value) > 0) {
                                cameraSelect.selectedIndex = i;
                                break;
                            }
                        }
                    } else if (previousSelection) {
                        // Try to restore previous selection
                        for (let i=0; i < cameraSelect.options.length; i++) {
                            if (cameraSelect.options[i].value === previousSelection) {
                                cameraSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    
                    if (data.cameras.length === 0) {
                        const option = document.createElement('option');
                        option.value = "0";
                        option.textContent = "Default Camera";
                        cameraSelect.appendChild(option);
                        
                        if (showToastOnSuccess) {
                            showToast('No cameras detected', 'warning');
                        }
                    } else {
                        if (showToastOnSuccess) {
                            const scanTimeInfo = data.scan_time ? ` (scan took ${data.scan_time})` : '';
                            const message = hasNonZeroOptions 
                                ? `Found ${data.cameras.length} camera(s)${scanTimeInfo} including USB camera(s)!` 
                                : `Found ${data.cameras.length} camera(s)${scanTimeInfo}`;
                            
                            showToast(message, 'success');
                            
                            // Add a visual highlight to the camera dropdown to draw attention to it
                            cameraSelect.style.boxShadow = "0 0 10px rgba(0,255,0,0.5)";
                            setTimeout(() => {
                                cameraSelect.style.boxShadow = "";
                            }, 3000);  // Remove highlight after 3 seconds
                        }
                    }
                    
                    // Restore button state
                    if (refreshBtn) {
                        refreshBtn.textContent = "Refresh Camera List";
                        refreshBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading camera list:', error);
                    showToast('Error loading camera list: ' + error.message, 'danger');
                    
                    // Restore button state
                    if (refreshBtn) {
                        refreshBtn.textContent = "Refresh Camera List";
                        refreshBtn.disabled = false;
                    }
                });
        }
        
        // Function to display a toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type}`;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '1000';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Function to check if camera is active
        function checkCameraStatus() {
            fetch('/camera/status')
                .then(response => response.json())
                .then(data => {
                    updateCameraUI(data.active);
                })
                .catch(error => {
                    console.error('Error checking camera status:', error);
                    showToast('Error checking camera status: ' + error.message, 'danger');
                });
        }
        
        // Function to update camera UI based on status
        function updateCameraUI(active) {
            cameraActive = active;
            cameraToggle.textContent = active ? 'Stop Camera' : 'Start Camera';
            
            if (active) {
                // Show camera stream and controls
                cameraPlaceholder.classList.add('hidden');
                cameraStream.classList.remove('hidden');
                recognitionControls.classList.remove('hidden');
                
                // Load camera info
                loadCameraInfo();
            } else {
                // Hide camera stream and controls
                cameraPlaceholder.classList.remove('hidden');
                cameraStream.classList.add('hidden');
                recognitionControls.classList.add('hidden');
                faceGalleries.classList.add('hidden');
                enrollForm.classList.add('hidden');
                
                // Reset welcome card and queue
                clearMemberQueue();
                
                // Clear intervals
                if (resultUpdateInterval) {
                    clearInterval(resultUpdateInterval);
                    resultUpdateInterval = null;
                }
                
                // Reset recognition state
                recognitionEnabled = false;
            }
        }
        
        // Function to start camera
        function startCamera() {
            const cameraId = parseInt(cameraSelect.value);
            
            // First reset the recognition state to start fresh
            resetCameraState();
            
            fetch('/camera/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: cameraId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentCameraId = cameraId;
                    // Use a timestamp to prevent caching issues
                    const timestamp = new Date().getTime();
                    cameraStream.src = `/camera/stream?id=${cameraId}&show_faces=false&t=${timestamp}`;
                    updateCameraUI(true);
                    
                    // Clear all existing member queues and UI elements
                    if (memberQueue.length > 0) {
                        clearMemberQueue();
                    }
                } else {
                    showToast('Error starting camera: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error starting camera:', error);
                showToast('Error starting camera: ' + error.message, 'danger');
            });
        }
        
        // Function to stop camera
        function stopCamera() {
            // First try to record attendance for all recognized members if recognition is enabled
            if (recognitionEnabled && document.querySelector('.meeting-banner')) {
                // Record attendance before stopping the camera
                recordAllAttendance()
                    .then(data => {
                        if (data) {
                            showToast(`Attendance recorded for ${data.recorded_count} members before stopping camera`, 'success');
                        }
                        // Continue with stopping the camera
                        stopCameraRequest();
                    })
                    .catch(error => {
                        console.error('Error recording attendance:', error);
                        // Continue with stopping the camera even if attendance recording fails
                        stopCameraRequest();
                    });
            } else {
                // Just stop the camera if recognition is not enabled or no active meeting
                stopCameraRequest();
            }
        }

        // Function to actually send the stop camera request
        function stopCameraRequest() {
            fetch('/camera/stop', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                updateCameraUI(false);
            })
            .catch(error => {
                console.error('Error stopping camera:', error);
                showToast('Error stopping camera: ' + error.message, 'danger');
            });
        }
        
        // Function to load camera info
        function loadCameraInfo() {
            fetch('/camera/info')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        cameraInfo.textContent = data.error;
                        return;
                    }
                    
                    cameraInfo.innerHTML = `
                        <p>Camera ID: ${data.id} | Resolution: ${data.width}x${data.height} | FPS: ${data.fps.toFixed(1)}</p>
                    `;
                    
                    // Update recognition state based on camera info
                    recognitionEnabled = data.recognition_enabled;
                    updateRecognitionUI();
                })
                .catch(error => {
                    console.error('Error loading camera info:', error);
                });
        }
        
        // Function to manage member queue and rotation
        function manageMemberQueue(knownFaces) {
            // Filter for in-view members only
            const inViewMembers = knownFaces.filter(face => face.in_view && face.type === 'known');
            
            // If no members in view, clear queue and show default state
            if (inViewMembers.length === 0) {
                clearMemberQueue();
                return;
            }
            
            // Check if the queue needs to be updated (members added or removed)
            const currentMemberIds = memberQueue.map(m => m.member_id);
            const inViewMemberIds = inViewMembers.map(m => m.member_id);
            
            // Check if queues are different (members added or left the frame)
            const needsQueueUpdate = 
                currentMemberIds.length !== inViewMemberIds.length ||
                inViewMemberIds.some(id => !currentMemberIds.includes(id)) ||
                currentMemberIds.some(id => !inViewMemberIds.includes(id));
                
            if (needsQueueUpdate) {
                // Update queue with current in-view members
                memberQueue = [...inViewMembers];
                
                // Reset to first member if current index is invalid
                if (currentMemberIndex >= memberQueue.length) {
                    currentMemberIndex = 0;
                }
                
                // Update queue indicators
                updateQueueIndicators();
                
                // If we don't have a rotation interval and should have one, start it
                if (memberQueue.length > 1 && !memberRotationInterval) {
                    startMemberRotation();
                } 
                // If we have a rotation but should not (one or zero members), stop it
                else if (memberQueue.length <= 1 && memberRotationInterval) {
                    stopMemberRotation();
                }
            }
            
            // If we have members, show the current one
            if (memberQueue.length > 0) {
                displayMember(memberQueue[currentMemberIndex]);
            } else {
                resetWelcomeCard();
            }
        }
        
        // Function to update queue indicator dots
        function updateQueueIndicators() {
            // Clear existing indicators
            queueIndicators.innerHTML = '';
            
            // If multiple members, show indicators
            if (memberQueue.length > 1) {
                queueIndicators.classList.remove('hidden');
                
                // Create indicator dots
                for (let i = 0; i < memberQueue.length; i++) {
                    const dot = document.createElement('div');
                    dot.className = `queue-dot ${i === currentMemberIndex ? 'active' : ''}`;
                    queueIndicators.appendChild(dot);
                }
            } else {
                queueIndicators.classList.add('hidden');
            }
        }
        
        // Function to start member rotation
        function startMemberRotation() {
            // Clear any existing interval
            stopMemberRotation();
            
            // Start new rotation
            memberRotationInterval = setInterval(() => {
                // Move to next member
                currentMemberIndex = (currentMemberIndex + 1) % memberQueue.length;
                
                // Update display and indicators
                displayMember(memberQueue[currentMemberIndex]);
                updateQueueIndicators();
            }, MEMBER_DISPLAY_TIME);
        }
        
        // Function to stop member rotation
        function stopMemberRotation() {
            if (memberRotationInterval) {
                clearInterval(memberRotationInterval);
                memberRotationInterval = null;
            }
        }
        
        // Function to clear the member queue entirely
        function clearMemberQueue() {
            memberQueue = [];
            currentMemberIndex = 0;
            stopMemberRotation();
            resetWelcomeCard();
            queueIndicators.classList.add('hidden');
        }
        
        // Function to reset welcome card to default state
        function resetWelcomeCard() {
            welcomeCard.classList.add('no-member');
            noMemberMessage.classList.remove('hidden');
            memberInfoContainer.classList.add('hidden');
            queueIndicators.classList.add('hidden');
        }
        
        // Function to display a specific member in the welcome card
        function displayMember(member) {
            if (!member) {
                resetWelcomeCard();
                return;
            }
            
            // Member is active, display their information
            welcomeCard.classList.remove('no-member');
            noMemberMessage.classList.add('hidden');
            memberInfoContainer.classList.remove('hidden');
            
            // Set member photo
            memberPhoto.src = `/camera/face_thumbnail/${member.thumbnail_id}`;
            
            // Set member name and welcome message
            memberName.textContent = member.name;
            
            // Get additional member information from API
            fetch(`/camera/member_info/${member.member_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading member info:', data.error);
                        return;
                    }
                    
                    // Update member details
                    memberMajor.textContent = data.major || 'Not specified';
                    memberAge.textContent = data.age || 'Not specified';
                    memberBio.textContent = data.bio || 'No biography available';
                    memberMeetings.textContent = data.meeting_count || '0';
                })
                .catch(error => {
                    console.error('Error loading member info:', error);
                });
        }
        
        // Legacy function for backwards compatibility
        function updateWelcomeCard(member) {
            if (!member) {
                resetWelcomeCard();
                return;
            }
            
            // For single member display (when directly clicking a face)
            clearMemberQueue();
            memberQueue = [member];
            currentMemberIndex = 0;
            displayMember(member);
        }
        
        // Helper to create a face card
        function createFaceCard(face, index) {
            const faceCard = document.createElement('div');
            faceCard.className = 'face-card';
            faceCard.dataset.faceIndex = index;
            faceCard.dataset.thumbnailId = face.thumbnail_id;
            
            // Add click events for face cards
            if (face.type === 'unknown') {
                // For unknown faces - open add member form
                faceCard.addEventListener('click', () => showAddMemberForm(face));
                
                // Add hint about clicking to enroll
                const enrollHint = document.createElement('div');
                enrollHint.className = 'edit-hint';
                enrollHint.textContent = 'Click to enroll';
                enrollHint.style.fontSize = '0.7rem';
                enrollHint.style.opacity = '0.7';
                enrollHint.style.marginTop = '2px';
                faceCard.appendChild(enrollHint);
                
            } else if (face.type === 'known') {
                // For known faces - show in welcome card (if clicked normally)
                // or open edit form (if clicked with Alt key pressed)
                faceCard.addEventListener('click', (e) => {
                    if (e.altKey) {
                        // Alt + Click opens the edit form
                        showEditMemberForm(face);
                    } else {
                        // Normal click just shows the member in the welcome card
                        updateWelcomeCard(face);
                    }
                });
                
                // Add hint about Alt+Click to edit
                const editHint = document.createElement('div');
                editHint.className = 'edit-hint';
                editHint.textContent = 'Alt+Click to edit';
                editHint.style.fontSize = '0.7rem';
                editHint.style.opacity = '0.7';
                editHint.style.marginTop = '2px';
                faceCard.appendChild(editHint);
            }
            
            // Create face thumbnail
            const thumbnail = document.createElement('img');
            thumbnail.className = 'face-thumbnail';
            thumbnail.alt = face.name;
            thumbnail.src = `/camera/face_thumbnail/${face.thumbnail_id}`;
            
            // Add face name
            const nameElem = document.createElement('div');
            nameElem.className = 'face-name';
            nameElem.textContent = face.name === 'Unknown' ? 'Unknown Face' : face.name;
            
            // Add status indicator
            const statusElem = document.createElement('div');
            statusElem.className = `face-status ${face.in_view ? 'status-in-view' : 'status-out-of-view'}`;
            statusElem.textContent = face.in_view ? 'In View' : 'Not in View';
            
            // Add action buttons container
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'face-actions';
            
            // Add appropriate actions based on face type
            if (face.type === 'unknown') {
                if (face.in_view) {
                    // For unknown faces in view: add enroll button
                    const enrollBtn = document.createElement('button');
                    enrollBtn.className = 'btn btn-warning btn-sm';
                    enrollBtn.textContent = 'Enroll';
                    enrollBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the card click event
                        selectFaceToEnroll(face.thumbnail_id, face);
                    });
                    actionsContainer.appendChild(enrollBtn);
                }
                
                // For all unknown faces: add remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger btn-sm';
                removeBtn.textContent = 'Dismiss';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the card click event
                    
                    // Call the API to remove this face
                    fetch(`/camera/remove_unknown_face/${face.thumbnail_id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the face card from the UI
                            faceCard.remove();
                            showToast('Face removed', 'success');
                        } else {
                            showToast(data.message || 'Failed to remove face', 'warning');
                        }
                    })
                    .catch(error => {
                        console.error('Error removing face:', error);
                        showToast('Error removing face: ' + error.message, 'danger');
                    });
                });
                actionsContainer.appendChild(removeBtn);
            }
            
            // Assemble the card
            faceCard.appendChild(thumbnail);
            faceCard.appendChild(nameElem);
            faceCard.appendChild(statusElem);
            
            // Only add actions container if it has buttons
            if (actionsContainer.children.length > 0) {
                faceCard.appendChild(actionsContainer);
            }
            
            return faceCard;
        }
        
        // Function to update face galleries
        function updateFaceGallery(faces) {
            // Clear current galleries
            recognizedFaces.innerHTML = '';
            unknownFaces.innerHTML = '';
            
            // Split faces into recognized and unknown
            const knownFaces = faces.filter(face => face.type === 'known');
            const unknownFacesList = faces.filter(face => face.type === 'unknown');
            
            // Sort faces: in-view first, then by most recently seen
            const sortFaces = (a, b) => {
                // In-view faces first
                if (a.in_view && !b.in_view) return -1;
                if (!a.in_view && b.in_view) return 1;
                
                // Then by last seen time
                return a.time_since_seen - b.time_since_seen;
            };
            
            knownFaces.sort(sortFaces);
            unknownFacesList.sort(sortFaces);
            
            // Handle recognized members gallery
            if (knownFaces.length > 0) {
                noRecognizedMessage.classList.add('hidden');
                knownFaces.forEach((face, index) => {
                    const card = createFaceCard(face, index);
                    recognizedFaces.appendChild(card);
                });
                
                // Update the welcome card queue with the known faces
                manageMemberQueue(knownFaces);
            } else {
                noRecognizedMessage.classList.remove('hidden');
                // Reset welcome card if no known faces
                clearMemberQueue();
            }
            
            // Handle unknown faces gallery
            if (unknownFacesList.length > 0) {
                noUnknownMessage.classList.add('hidden');
                unknownFacesList.forEach((face, index) => {
                    const card = createFaceCard(face, index);
                    unknownFaces.appendChild(card);
                });
            } else {
                noUnknownMessage.classList.remove('hidden');
            }
            
            // Show galleries if we have faces
            if (faces.length > 0) {
                faceGalleries.classList.remove('hidden');
            } else {
                faceGalleries.classList.add('hidden');
            }
        }
        
        // Function to show Add Member Form for unknown faces
        function showAddMemberForm(face) {
            // Set modal title and action
            memberModalTitle.textContent = 'Add New Member';
            formAction.value = 'add';
            
            // Set face thumbnail
            modalFacePreview.src = `/camera/face_thumbnail/${face.thumbnail_id}`;
            
            // Store face ID for form submission
            formFaceId.value = face.thumbnail_id;
            formMemberId.value = '';
            
            // Make sure to also set the currentSelectedFaceIndex for the other form
            currentSelectedFaceIndex = face.thumbnail_id;
            console.log("Set current face ID in modal:", face.thumbnail_id);
            
            // Clear form fields
            formName.value = '';
            formMajor.value = '';
            formAge.value = '';
            formBio.value = '';
            
            // Show the modal
            memberModalOverlay.classList.remove('hidden');
        }
        
        // Function to show Edit Member Form for known faces
        function showEditMemberForm(face) {
            // Set modal title and action
            memberModalTitle.textContent = 'Edit Member';
            formAction.value = 'edit';
            
            // Set face thumbnail
            modalFacePreview.src = `/camera/face_thumbnail/${face.thumbnail_id}`;
            
            // Store IDs for form submission
            formFaceId.value = face.thumbnail_id;
            formMemberId.value = face.member_id;
            
            // Load member data from API
            fetch(`/camera/member_info/${face.member_id}`)
                .then(response => response.json())
                .then(data => {
                    // Fill form with member data
                    formName.value = data.name || '';
                    formMajor.value = data.major || '';
                    formAge.value = data.age || '';
                    formBio.value = data.bio || '';
                    
                    // Show the modal
                    memberModalOverlay.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading member info:', error);
                    showToast('Error loading member information. Please try again.', 'danger');
                });
        }
        
        // Function to close the member modal
        function closeModal() {
            memberModalOverlay.classList.add('hidden');
        }
        
        // Legacy function for backward compatibility
        function selectFaceToEnroll(thumbnailId, face) {
            // Make sure to set the current selected face index to the thumbnail ID
            // This ensures we're sending the correct ID to the server
            currentSelectedFaceIndex = thumbnailId;
            console.log("Selected face to enroll with ID:", currentSelectedFaceIndex);
            showAddMemberForm(face);
        }
        
        // Function to update recognition results and face gallery
        function updateRecognitionResult() {
            if (!recognitionEnabled) return;
            
            fetch('/camera/recognition/result')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        return;
                    }
                    
                    // Update the face gallery with the detected faces
                    updateFaceGallery(data.faces);
                })
                .catch(error => {
                    console.error('Error updating recognition result:', error);
                    showToast('Error updating recognition result: ' + error.message, 'danger');
                });
        }
        
        // Function to update UI based on recognition state
        // Function to record attendance for all recognized members
        function recordAllAttendance() {
            return fetch('/camera/record_all_attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Attendance recorded for ${data.recorded_count} members`);
                    return data;
                } else {
                    console.warn('Error recording attendance:', data.error);
                    return null;
                }
            })
            .catch(error => {
                console.error('Error recording attendance:', error);
                return null;
            });
        }
        
        function updateRecognitionUI() {
            toggleRecognitionBtn.textContent = recognitionEnabled ? 
                'Disable Face Recognition' : 'Enable Face Recognition';
            
            if (recognitionEnabled) {
                faceGalleries.classList.remove('hidden');
                toggleShowFacesBtn.classList.remove('hidden');
                // Start periodic result updates
                if (!resultUpdateInterval) {
                    resultUpdateInterval = setInterval(updateRecognitionResult, 1000);
                    updateRecognitionResult();
                }
                
                // Start periodic attendance recording if there's an active meeting
                if (!attendanceRecordInterval && document.querySelector('.meeting-banner')) {
                    // Record attendance every 60 seconds to ensure all recognized members are recorded
                    attendanceRecordInterval = setInterval(() => {
                        // Only record if there are actually recognized members
                        if (document.querySelectorAll('#recognized-faces .face-card').length > 0) {
                            recordAllAttendance().then(data => {
                                if (data && data.recorded_count > 0) {
                                    console.log(`Periodic attendance recorded for ${data.recorded_count} members`);
                                }
                            });
                        }
                    }, 60000); // Every 60 seconds
                }
                
                // Add record attendance button if it doesn't exist and there's an active meeting
                const activeRecordBtn = document.getElementById('record-attendance-btn');
                if (!activeRecordBtn && document.querySelector('.meeting-banner')) {
                    const recordBtn = document.createElement('button');
                    recordBtn.id = 'record-attendance-btn';
                    recordBtn.className = 'btn btn-warning';
                    recordBtn.textContent = 'Record Attendance for All Members';
                    recordBtn.style.marginLeft = '10px';
                    recordBtn.addEventListener('click', function() {
                        this.disabled = true;
                        this.textContent = 'Recording...';
                        
                        recordAllAttendance()
                            .then(data => {
                                if (data) {
                                    showToast(`Attendance recorded for ${data.recorded_count} members`, 'success');
                                } else {
                                    showToast('Failed to record attendance', 'danger');
                                }
                            })
                            .finally(() => {
                                this.disabled = false;
                                this.textContent = 'Record Attendance for All Members';
                            });
                    });
                    
                    // Add button after the toggle recognition button
                    toggleRecognitionBtn.parentNode.insertBefore(recordBtn, toggleRecognitionBtn.nextSibling);
                }
            } else {
                faceGalleries.classList.add('hidden');
                toggleShowFacesBtn.classList.add('hidden');
                enrollForm.classList.add('hidden');
                // Reset welcome card and queue
                clearMemberQueue();
                // Stop periodic updates
                if (resultUpdateInterval) {
                    clearInterval(resultUpdateInterval);
                    resultUpdateInterval = null;
                }
                
                // Stop periodic attendance recording
                if (attendanceRecordInterval) {
                    clearInterval(attendanceRecordInterval);
                    attendanceRecordInterval = null;
                }
                
                // Remove record attendance button if it exists
                const recordBtn = document.getElementById('record-attendance-btn');
                if (recordBtn) {
                    recordBtn.remove();
                }
            }
        }
        
        // Toggle camera
        cameraToggle.addEventListener('click', function() {
            if (cameraActive) {
                stopCamera();
            } else {
                startCamera();
            }
        });
        
        // Toggle face recognition
        toggleRecognitionBtn.addEventListener('click', function() {
            // If turning off recognition and there's an active meeting, record attendance first
            if (recognitionEnabled && document.querySelector('.meeting-banner')) {
                // First record attendance for all recognized members
                recordAllAttendance()
                    .then(data => {
                        if (data) {
                            showToast(`Attendance recorded for ${data.recorded_count} members`, 'success');
                        }
                        // Then proceed with toggling recognition
                        toggleRecognitionRequest();
                    })
                    .catch(error => {
                        console.error('Error recording attendance:', error);
                        // Continue with toggling recognition even if attendance recording fails
                        toggleRecognitionRequest();
                    });
            } else {
                // Just toggle recognition
                toggleRecognitionRequest();
            }
        });
        
        // Function to actually send the toggle recognition request
        function toggleRecognitionRequest() {
            fetch('/camera/recognition/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: !recognitionEnabled }),
            })
            .then(response => response.json())
            .then(data => {
                recognitionEnabled = data.recognition_enabled;
                updateRecognitionUI();
            })
            .catch(error => {
                console.error('Error toggling recognition:', error);
                showToast('Error toggling recognition: ' + error.message, 'danger');
            });
        }
        
        // Toggle showing face boxes
        toggleShowFacesBtn.addEventListener('click', function() {
            showFaces = !showFaces;
            toggleShowFacesBtn.textContent = showFaces ? 
                'Hide Face Boxes' : 'Show Face Boxes';
            
            // Update the stream URL with a timestamp to force reload
            const timestamp = new Date().getTime();
            cameraStream.src = `/camera/stream?id=${currentCameraId}&show_faces=${showFaces}&t=${timestamp}`;
        });
        
        // Refresh camera list
        refreshBtn.addEventListener('click', function() {
            // Call loadCameraList with showToastOnSuccess=true to show result messages
            loadCameraList(true);
        });
        
        // Handle member enrollment
        saveFaceBtn.addEventListener('click', function() {
            const name = personNameInput.value.trim();
            const major = personMajorInput.value.trim();
            const age = personAgeInput.value ? parseInt(personAgeInput.value) : null;
            const bio = personBioInput.value.trim();
            
            if (!name) {
                showToast('Please enter a name', 'warning');
                return;
            }
            
            // Show processing indicator
            saveFaceBtn.textContent = "Saving...";
            saveFaceBtn.disabled = true;
            
            // Log the face ID we're sending for debugging
            console.log("Enrolling face with ID:", currentSelectedFaceIndex);
            
            fetch('/camera/recognition/enroll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    name: name,
                    major: major || null,
                    age: age,
                    bio: bio || null,
                    face_index: currentSelectedFaceIndex
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                } else {
                    showToast(data.message || "Member enrolled successfully", 'success');
                    
                    // Hide form and reset fields
                    enrollForm.classList.add('hidden');
                    personNameInput.value = '';
                    personMajorInput.value = '';
                    personAgeInput.value = '';
                    personBioInput.value = '';
                    
                    // Reset button
                    saveFaceBtn.textContent = "Save Member";
                    saveFaceBtn.disabled = false;
                    
                    // Force immediate update of the recognition results
                    updateRecognitionResult();
                    
                    // Add timestamp to force refresh of the video stream
                    const timestamp = new Date().getTime();
                    cameraStream.src = `/camera/stream?id=${currentCameraId}&show_faces=${showFaces}&t=${timestamp}`;
                }
            })
            .catch(error => {
                console.error('Error enrolling face:', error);
                showToast('Error enrolling face: ' + error.message, 'danger');
                
                // Reset button
                saveFaceBtn.textContent = "Save Member";
                saveFaceBtn.disabled = false;
            });
        });
        
        cancelEnrollBtn.addEventListener('click', function() {
            enrollForm.classList.add('hidden');
            personNameInput.value = '';
            personMajorInput.value = '';
            personAgeInput.value = '';
            personBioInput.value = '';
            
            // Reset button if it was in saving state
            saveFaceBtn.textContent = "Save Member";
            saveFaceBtn.disabled = false;
            
            // Reset selected face index
            currentSelectedFaceIndex = -1;
        });
        
        // Modal events
        closeModalBtn.addEventListener('click', closeModal);
        cancelFormBtn.addEventListener('click', closeModal);
        
        // Handle clicks outside the modal to close it
        memberModalOverlay.addEventListener('click', function(e) {
            if (e.target === memberModalOverlay) {
                closeModal();
            }
        });
        
        // Handle escape key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !memberModalOverlay.classList.contains('hidden')) {
                closeModal();
            }
        });
        
        // Handle form submission
        memberForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Disable save button to prevent double submissions
            saveFormBtn.disabled = true;
            saveFormBtn.textContent = 'Saving...';
            
            // Get the face ID from the form
            const faceId = formFaceId.value;
            console.log("Submitting form with face ID:", faceId);
            
            // Prepare form data
            const formData = {
                name: formName.value.trim(),
                major: formMajor.value.trim() || null,
                age: formAge.value ? parseInt(formAge.value) : null,
                bio: formBio.value.trim() || null,
                face_index: faceId,
                action: formAction.value
            };
            
            // For edit action, include member_id
            if (formAction.value === 'edit') {
                formData.member_id = formMemberId.value;
            }
            
            // Send data to server
            const endpoint = formAction.value === 'add' 
                ? '/camera/recognition/enroll'
                : '/camera/member/update';
                
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                    saveFormBtn.disabled = false;
                    saveFormBtn.textContent = 'Save Member';
                    return;
                }
                
                // Show success message
                showToast(data.message || "Member saved successfully", 'success');
                
                // Close the modal
                closeModal();
                
                // Reset form and button
                memberForm.reset();
                saveFormBtn.disabled = false;
                saveFormBtn.textContent = 'Save Member';
                
                // For add action with successful enrollment, add to queue
                if (formAction.value === 'add' && data.member_id) {
                    // Force update of recognition results to get the new member
                    updateRecognitionResult();
                    
                    // After a brief delay, refresh video stream to get updated face detection
                    setTimeout(() => {
                        const timestamp = new Date().getTime();
                        cameraStream.src = `/camera/stream?id=${currentCameraId}&show_faces=${showFaces}&t=${timestamp}`;
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error saving member:', error);
                showToast('Error saving member: ' + error.message, 'danger');
                
                // Reset button
                saveFormBtn.disabled = false;
                saveFormBtn.textContent = 'Save Member';
            });
        });
        
        // Reset camera state when page loads - this ensures we start fresh for each meeting
        function resetCameraState() {
            fetch('/camera/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Camera state reset successfully');
                    // Force update if camera is active
                    if (cameraActive && recognitionEnabled) {
                        updateRecognitionResult();
                    }
                } else {
                    console.warn('Error resetting camera state:', data.error);
                }
            })
            .catch(error => {
                console.error('Error resetting camera state:', error);
            });
        }
        
        // Load cameras on page load
        loadCameraList();
        checkCameraStatus();
        
        // Reset camera state when page loads
        resetCameraState();
    });
</script>
{% endblock %}